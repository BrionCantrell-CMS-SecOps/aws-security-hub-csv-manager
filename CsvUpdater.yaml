# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0

# Permission is hereby granted, free of charge, to any person obtaining a copy of this
# software and associated documentation files (the "Software"), to deal in the Software
# without restriction, including without limitation the rights to use, copy, modify,
# merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
# PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

AWSTemplateFormatVersion: '2010-09-09'
Description: Provision CSV Manager for Security Hub Update Lambda, Event, and Automation.
Parameters: 
  CodeArchive:
    Type: String
    Description: The code archive S3 key returned by csvPrepare.py 
    Default: "zip/lambda.zip"
  PrimaryRegion:
    Type: String
    Description: "The region in which the S3 bucket and SSM parameters are stored"
    Default: ""
Mappings:
  PartitionMap:
    aws:
      principals:
      - lambda.amazonaws.com
      - ec2.amazonaws.com
      - ssm.amazonaws.com
    aws-us-gov:
      principals:
      - ec2.amazonaws.com
      - lambda.amazonaws.com
      - ssm.amazonaws.com
Resources:
  Role:
    Type: AWS::IAM::Role
    Properties:
      Description: "Allow Lambda, EC2, and SSM to carry out necessary operations"
      AssumeRolePolicyDocument:
        Statement:
          Effect: Allow
          Principal:
            Service: !FindInMap [ PartitionMap, !Ref AWS::Partition, "principals" ]
          Action: sts:AssumeRole
      Policies:
        - PolicyName: CsvManagerForSecurityHub
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Sid: Iam
              Effect: Allow
              Action:
              - iam:GetRole
              - iam:PassRole
              - iam:CreateServiceLinkedRole
              Resource: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/*"
            - Sid: Sts
              Effect: Allow
              Action:
              - sts:AssumeRole
              - sts:GetCallerIdentity
              Resource: "*"
            - Sid: S3
              Effect: Allow
              Action:
              - s3:PutObject
              - s3:GetObject
              Resource: 
              - !Sub "arn:${AWS::Partition}:s3:::{{resolve:ssm:/csvManager/bucket}}"
              - !Sub "arn:${AWS::Partition}:s3:::{{resolve:ssm:/csvManager/bucket}}/*"
            - Sid: SecurityHub
              Effect: Allow
              Action:
              - securityhub:GetFindings
              - securityhub:BatchUpdateFindings
              Resource: "*"
            - Sid: Lambda
              Effect: Allow
              Action:
              - lambda:InvokeFunction
              Resource: !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}-${AWS::AccountId}"
            - Sid: Ssm
              Effect: Allow
              Action:
              - ssm:PutParameter
              - ssm:GetParameters
              Resource: !Sub "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/csvManager/*"
      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
  Lambda:
    Type: AWS::Lambda::Function
    Properties: 
      FunctionName: !Sub "${AWS::StackName}-${AWS::AccountId}"
      Code: 
        S3Bucket: "{{resolve:ssm:/csvManager/bucket:1}}"
        S3Key: !Ref CodeArchive
      Description: "Update Security Hub findings from CSV file"
      Handler: csvUpdater.lambdaHandler
      MemorySize: 512
      Role: !GetAtt Role.Arn
      Runtime: "python3.9"
      Timeout: 900
      Tags:
      - Key: CodeArchiveKey
        Value: !Ref CodeArchive
      Environment:
        Variables:
          CSV_PRIMARY_REGION: !Ref PrimaryRegion
  LambdaAutomation:
    Type: AWS::SSM::Document
    Properties:
      DocumentType: "Automation"
      Content:
        description: |-
          # Update Findings in Security Hub (csvUpdater) 
          This Systems Manager (SSM) Automation allows you to update findings 
          in Security Hub using csvUpdater.py
        schemaVersion: '0.3'
        assumeRole: !GetAtt Role.Arn
        parameters:
          Source:
            type: String
            default: ""
            description: An S3 URL containing the CSV file to update
        mainSteps:
        - name: InvokeLambda
          action: 'aws:invokeLambdaFunction'
          inputs:
            InvocationType: RequestResponse
            FunctionName: !Sub "${AWS::StackName}-${AWS::AccountId}"
            Payload: !Sub '{ "input" : "{{Source}}" , "primaryRegion" : "${PrimaryRegion}"}'
          description: Invoke the csvUpdater lambda function
          outputs:
          - Name: resultCode
            Selector: $.Payload.resultCode
            Type: Integer
          isEnd: true
